# Telehealth Schedule & Booking App - Expanded Technical Analysis (v0.3.3)

**Date:** 2025-10-28
**Scope:** Deep-dive analysis of raw source code (`.fx.yaml`, `.json`, `.sarif`) for critical screens and components.
**Note:** This document expands upon the initial analysis report (Sections 1-29).

---

### 30. App Checker Analysis (Static Analysis)

**Source:** `Entropy/AppCheckerResult.sarif`
**Summary:** The static analysis reveals significant delegation warnings and accessibility gaps.

**Key Findings:**
- **Delegation Warnings:**
  - `CountIf` usage on SharePoint lists (e.g., `TelehealthMasterSched_CombiTable`) is flagged as non-delegable. This means the app will only process the first 500/2000 records locally, potentially showing incorrect availability data as the dataset grows.
  - `Lower()` and `Trim()` functions used in filter criteria are often non-delegable.
- **Accessibility:**
  - Multiple controls (Icons, Images) are missing `AccessibleLabel`.
  - `TabIndex` is not consistently managed, which may trap keyboard users.
  - Focus borders are missing on some custom buttons.

---

### 31. Connection Analysis

**Source:** `Connections/Connections.json`
**Data Sources:**
- **SharePoint:**
  - `TelehealthResourceApp` (Site)
  - `TelehealthTeamApp` (Site)
- **Lists:**
  - `App_ReservationLog` (Booking history)
  - `TelehealthMasterSched_CombiTable` (Master schedule)
  - `RoomMasterData` (Room metadata)
- **Office365Users:** Used for user profile photos and email retrieval.

**Risk:**
- The app relies on two different SharePoint sites. Ensure permissions are synchronized between them to prevent access denied errors for users who have access to one but not the other.

---

### 32. Deep Dive: Reservation Screen (`Src/Reservation.fx.yaml`)

**Fragile Field Mapping:**
The screen uses internal SharePoint column names (e.g., `field_1`, `field_2`) in several places instead of logical names.
- **Risk:** If the SharePoint list structure changes or is re-created, these internal names might change, breaking the app.
- **Recommendation:** Refactor to use logical names (e.g., `Title`, `BookingDate`) exclusively.

**Commented-Out Logic:**
Large blocks of code (e.g., in `btnSubmit`) are commented out, indicating incomplete features or abandoned logic.
- **Action:** Remove dead code to improve maintainability.

---

### 33. Deep Dive: ManageDesks Screen (`Src/ManageDesks.fx.yaml`)

**Critical Bug: Delete Functionality**
The "Delete" button (or "Mark Inactive") logic uses a `Patch` command that is missing the record argument.
```powerfx
// Current Logic (Simplified)
Patch(TelehealthMasterSched_CombiTable, {RoomActive_text: "MARKED FOR DELETE"})
```
- **Impact:** Instead of updating the *selected* room to be inactive, this creates a *new* record with only that one field populated.
- **Fix:** `Patch(TelehealthMasterSched_CombiTable, varSelectedRoom, {RoomActive_text: "MARKED FOR DELETE"})`

---

### 34. Component Analysis

**Dialog Component (`Dialog`)**
- **Usage:** Used for confirmation dialogs (e.g., "Confirm Cancellation").
- **Props:** `Title`, `Message`, `ConfirmButtonText`, `CancelButtonText`.
- **Issues:**
  - Hardcoded colors in some instances.
  - `Visible` property often controlled by a simple boolean variable (`varShowDialog`), which can be buggy if multiple dialogs share the same variable.

**Header Component (`Header`)**
- **Usage:** Standard header across screens.
- **Props:** `Title`, `ShowBackArrow`.
- **Issues:**
  - Inconsistent usage; some screens implement their own header using groups instead of the component.

**Panel Component (`Panel`)**
- **Usage:** Side panel for navigation or details.
- **Issues:**
  - Z-index management is manual; often obscured by other controls if not carefully placed.

---

### 35. Deep Dive: NewEditDesk Screen (`Src/NewEditDesk.fx.yaml`)

**Critical Bug: Control Object Passed Instead of Value**
In the `Button1_6` (Save) `OnSelect` property, the `Patch` function contains a severe error where Control objects are passed directly to SharePoint columns instead of their `.Text` or `.Value` properties.

```powerfx
// CURRENT BROKEN CODE (Excerpt)
Patch(
    TelehealthMasterSched_CombiTable,
    Defaults(TelehealthMasterSched_CombiTable),
    {
        CBOC_Name_text: tbNameDesk.Text,
        Room_number: tbRoomNumberDesk,       // <--- BUG: Passing Control, not tbRoomNumberDesk.Text
        RoomActive_text: toggleActive.Value,
        Room_Alias_number: tbAlias,          // <--- BUG: Passing Control, not tbAlias.Text
        Room_Extension_number: tbRoomNumberDesk_1, // <--- BUG: Passing Control
        // ...
    }
)
```

**Impact:**
- This will likely cause the Patch operation to fail or save the string `"[object Object]"` into the SharePoint list if the column type allows text.
- If the column expects a Number, this will result in a type mismatch error at runtime.

**Recommendation:**
- Immediately correct all references to use `.Text` (e.g., `tbRoomNumberDesk.Text`).

**Other Findings:**
- **Hardcoded "New" vs "Edit" Logic:** The code explicitly checks `varDeskMode = "New"`. If this variable state is lost or incorrect, the form behavior is undefined.
- **Redundant Logic:** The `Patch` code is duplicated for "New" and "Edit" (inside `ForAll`) with identical field mappings. This violates DRY (Don't Repeat Yourself) principles.

---

### 36. Deep Dive: Confirm Screen (`Src/Confirm.fx.yaml`)

**Fragile String Matching Logic**
The `btnLooksGood` (Submit) button relies on extremely fragile string matching logic for recurrence and scheduling.

```powerfx
// Fragile Logic Example
Expiration_Start_DateTime: If(
    "Do not repeat this reservation, it is for one single occurance only" in varRecurrance,
    ...
)
```

**Risk:**
- If the text in the `RadioGroup` on the previous screen is changed even slightly (e.g., fixing a typo), this logic will silently fail, and the expiration date will be incorrect.

**Hardcoded Day Logic:**
The `Patch` operation has hardcoded `If` statements for every day of the week:

```powerfx
Day_Monday_text: If(varSelectedSched_days="Mondays", varClinicalFreeText, ThisRecord.Day_Monday_text),
Day_Tuesday_text: If(varSelectedSched_days="Tuesdays", varClinicalFreeText, ThisRecord.Day_Tuesday_text),
// ... repeats for all days
```

**Recommendation:**
- Use ID-based or Enum-based logic for recurrence instead of matching long user-facing strings.
- Refactor the day mapping to be dynamic or use a collection that maps "Mondays" to the column name if possible (though Power Apps makes dynamic column references hard, a Switch statement is cleaner than repeated Ifs).

---

### 37. Deep Dive: Schedule_Screen (`Src/Schedule_Screen.fx.yaml`)

**Scalability Risk: `ClearCollect` Limit**
The screen initializes with:
```powerfx
ClearCollect(col_CombiTable, TelehealthMasterSched_CombiTable)
```
**Risk:**
- `ClearCollect` is non-delegable for large datasets. It will only retrieve the first 500 (or 2000, if configured) records.
- As the `TelehealthMasterSched_CombiTable` grows beyond this limit, rooms will silently disappear from the schedule app.

**UI Performance: 5 Separate Galleries**
The screen uses 5 distinct vertical galleries (`Gallery_Monday`, `Gallery_Tuesday`, etc.) to render the schedule.
- **Impact:** This is heavy on the DOM and rendering engine.
- **Maintenance:** Any change to the card design must be replicated 5 times.
- **Recommendation:** Use a single horizontal gallery for days, nested with a vertical gallery for slots, or a single flexible height gallery grouped by day.

**Hardcoded Day Logic in Galleries:**
Each gallery has hardcoded `OnSelect` logic:
```powerfx
// Gallery_Monday OnSelect
Set(varSelectedDayOfWeek, 2);
Set(varSelectedSched_days, "Mondays");
```
This makes the app rigid and difficult to extend (e.g., adding weekends).

---

### 38. Deep Dive: ModifyTimeSlot Screen (`Src/ModifyTimeSlot.fx.yaml`)

**Maintenance Nightmare: Date Calculation Switch**
The `OnVisible` property contains a massive, hardcoded `Switch` statement to calculate the next occurrence of a day.

```powerfx
Switch(
    varSelectedDayOfWeek,
    1, Switch(Weekday(Today()), 1, ... 2, ...), // 7 lines of code
    2, Switch(Weekday(Today()), 1, ... 2, ...), // 7 lines of code
    // ... repeats for all 7 days
)
```
**Improvement:**
This entire block (approx. 50 lines) can be replaced with a single mathematical formula:
```powerfx
DateAdd(Today(), Mod(varSelectedDayOfWeek - Weekday(Today()) + 7, 7), Days)
```

**Hardcoded Clinic Mappings:**
The clinic filtering logic is hardcoded to specific building names:
```powerfx
Switch(
    dropdown_filterBLDG.Selected.Value,
    "Aurora", "AUR",
    "Hoffman Estates", "HE",
    // ...
)
```
**Risk:** Adding a new CBOC requires modifying the app code. This mapping should live in a SharePoint list (e.g., `RoomMasterData`).

**Typo in Logic:**
The code checks for a specific typo in the attestation string:
```powerfx
varDoubleBook_Attestation = "I aknowledge" // Typo: "acknowledge"
```
If the UI text is corrected to "I acknowledge", this logic will break.

---

### 39. Conclusion & Roadmap

This deep-dive analysis of the raw source code has revealed several critical issues that were not visible in the surface-level review.

**Top 3 Critical Fixes Required:**
1.  **Fix `NewEditDesk` Patch:** Change `tbRoomNumberDesk` to `tbRoomNumberDesk.Text` (and similar fields) immediately to prevent data corruption.
2.  **Fix `ManageDesks` Delete:** Add the record argument to the `Patch` function to ensure it updates the existing row instead of creating a new "MARKED FOR DELETE" row.
3.  **Scalability Refactor:** Remove `ClearCollect(col_CombiTable)` and implement delegable `Filter` calls directly against the SharePoint data source to support >2000 rooms/slots.

**Next Steps:**
- **Immediate:** Apply the "Top 3" fixes.
- **Short Term:** Refactor `ModifyTimeSlot` date logic and `Confirm` screen string matching.
- **Long Term:** Redesign `Schedule_Screen` to use a single gallery and dynamic data sources.

This concludes the comprehensive analysis of the Telehealth Schedule & Booking App (v0.3.3).

---

## 40. Deep Dive: App.fx.yaml (Global Logic)

### 40.1 Critical Scalability Blocker
The `OnStart` property contains a fatal scalability flaw:
```powerfx
ClearCollect(col_CombiTable, TelehealthMasterSched_CombiTable);
```
- **Impact:** This attempts to load the *entire* master schedule into a local collection.
- **Limit:** Power Apps collections are hard-capped at 2,000 rows (with configuration).
- **Result:** As soon as the schedule history exceeds 2,000 entries, the app will silently stop loading newer data, causing "missing" bookings for users.

### 40.2 Hardcoded Admin Access
Security logic is hardcoded to specific individuals:
```powerfx
If(
    User().Email in (Lower(App_User_list[@Email_Text])) || (Lower(User().Email) = "kyle.coder@va.gov"),
    Set(varAdmin, true),
    Set(varAdmin, false)
);
```
- **Risk:** Hardcoding specific email addresses (`kyle.coder@va.gov`) in source code is a maintenance nightmare and security anti-pattern.
- **Fix:** Use a SharePoint group or the `App_User_list` exclusively for role management.

---

## 41. Deep Dive: MyAppts.fx.yaml (My Bookings)

### 41.1 The "Placebo" Cancel Button
The cancellation workflow is completely non-functional. The "CONFIRM" button (`btnConfirmDelete_1`) contains this code:
```powerfx
OnSelect: =Notify("ALERT - ERROR!!!! Change not correctly recorded or submitted!!!")
```
- **Severity:** **CRITICAL**
- **Observation:** The button does not attempt to patch the record, remove the item, or trigger a flow. It explicitly notifies the user of an error without trying to perform the action.
- **Implication:** Users cannot cancel bookings from this screen.

### 41.2 Hardcoded Logic in Filters
The gallery filter contains specific user exceptions:
```powerfx
Lower(selectedClinicalStaff_email) = Lower("Myra.Sy@va.gov")
```
- **Risk:** Business logic exceptions for specific users should never be hardcoded in the UI layer.

### 41.3 Delegation Risks
The gallery `gallUpcoming` uses a complex `Filter` with `SortByColumns`:
```powerfx
SortByColumns(
    Filter(
        App_ReservationLog,
        currentUser.Email = selectedClinicalStaff_email || ...
    ),
    "Modified",
    SortOrder.Descending
)
```
- **Risk:** Complex `OR` conditions combined with `SortByColumns` often break delegation in SharePoint, falling back to the 500/2000 row limit. Users with older bookings might not see new ones if the dataset grows large.
