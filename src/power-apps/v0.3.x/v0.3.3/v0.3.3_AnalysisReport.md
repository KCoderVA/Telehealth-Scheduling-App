# Telehealth Scheduling App v0.3.3 – Canvas App Analysis Report

## 1. Overview

This report analyzes the unpacked Canvas app source under `src/power-apps/v0.3.x/v0.3.3/.unpacked`. It focuses on:

- Functional behavior of key screens and components
- Reliability of variable initialization and cross-screen dependencies
- Potential bugs or broken interactions (buttons, OnSelect/OnVisible, galleries)
- Unused / legacy logic and simplification opportunities

The app is a phone-layout Telehealth scheduling and reservation interface backed by SharePoint lists `TelehealthMasterSched_CombiTable` and `App_ReservationLog`, with additional lists like `List_Desks` and `App_User_list`.

Screens of special interest (per request):

- `Dashboard`
- `Schedule_Screen`
- `ModifyTimeSlot`
- `MyAppts`
- `Confirm`
- `ManageDesks`
- `NewEditDesk`
- `Reservation`

Other screens analyzed in this report:

- `BookFor`
- `Charts`
- `DateSelection`
- `DeskSelect`
- `NewBooking`

Navigation and shared UX are largely driven by bottom `Tabs_1`-derived components (`Tabs_3`, `Tabs_16`, `Tabs_17`, etc.) plus screen-level buttons.

## 2. Global App Behavior (App.OnStart & Core Variables)

**Key file:** `Src/App.fx.yaml`

### 2.1 What App.OnStart does

- Starts a preload timer (`var_appPreloadingTimer`) used by `Preloader_2` on `Dashboard`.
- Sets current user context:
  - `currentUser = User()`
  - `curUserDetails = Office365Users.MyProfile()`
  - `selectedPerson = curUserDetails`
  - `curUserPhoto = Office365Users.UserPhotoV2(curUserDetails.Mail)`
- Theme and behavior toggles:
  - `varTheme = "Light"`
  - `varAllowMultipleDeskSelections = true`
- Loads core collections:
  - `col_Desks` from `List_Desks`
  - `col_DeskListAdmin` from `App_User_list`
  - `col_CombiTable` from `TelehealthMasterSched_CombiTable`
  - `col_Reservations` from `App_ReservationLog`
- Initializes navigation/flow flags:
  - `varRedirectedSchedScreen = false`
- Admin detection:
  - `varAdmin = true` if `User().Email` is in `Lower(App_User_list[@Email_Text])` **OR** equals `"kyle.coder@va.gov"` (hard-coded override)

### 2.2 Observations

- **Admin logic** is explicit and simple; multiple commented-out approaches remain in the file (historical attempts with `LookUp` and various conditions).
- **Collections** loaded in `OnStart` are also reloaded on `Dashboard.OnVisible` and various schedule/refresh actions, which is safe but slightly redundant (not a functional bug).
- `BindingErrorCount = 6` in `CanvasManifest.json` indicates unresolved bindings somewhere (likely unused controls or mis-typed fields). These will surface as red error dots in the editor but are not fatal if the controls are hidden/unused.

### 2.3 Safe recommendations

1. **Document critical globals in one place**
   - Create a short markdown or text section in this report (or separate file) documenting the purpose of each of the following: `varAdmin`, `varRedirectedSchedScreen`, `varSelectedSched_*`, `col_SlotsToBeModified`, `varSubmission_DoubleBook`, `varDoubleBook_Attestation`, `selectedVistAClinic`, `varClinicalFreeText`, `varRecurrance`.
   - This will help avoid regressions when editing screen-level formulas.
2. **Admin detection – keep current implementation, but remove dead commented variant**
   - The active admin condition is correct and used by multiple tabs for visibility.
   - The long commented block in `App.OnStart` is now dead code and can cause confusion. It is safe to delete or move into a clearly labeled comment section at the bottom of `OnStart`.

## 3. Dashboard Screen & Tabs_3 (Admin-only "Edit Rooms")

**Key file:** `Src/Dashboard.fx.yaml`

### 3.1 Current behavior

- `Dashboard.OnVisible`:
  - Resets a large set of variables that affect schedule selection, reservation context, and instructions.
  - Refreshes key collections from SharePoint (`col_Desks`, `col_DeskListAdmin`, `col_CombiTable`, `col_Reservations`).
  - Clears various local/temporary collections (`col_SlotsToBeModified`, `selectedDesks`, `col_FilteredClinics`, `col_TelehealthClinics`).
- Two reservation preview galleries exist:
  - `gallMyReservationsPreview_testing` backed by `App_ReservationLog` (`currentUser.Email = selectedClinicalStaff_email || Modified_SubmitterEmail_text = currentUser.Email`)
  - `gallMyReservationsPreview_1` backed by `List_DeskReservations` and using `ReservedBy_Person.Email`
- `Button1_3` ("View Schedule") is hidden; `Button1` ("Create a new Reservation") is the primary CTA.
- Bottom tabs (`Tabs_3.Items`): Home, Submissions, Edit Rooms, Create New (Edit Rooms currently visible to all)

### 3.2 Issue 4a – "Edit Rooms" visibility for admins only

```powerfx
// Tabs_3.Items – CURRENT (Edit Rooms visible to all)
Table(
    { Name: "Home", Icon: Icon.Home, Page: Dashboard, Visible: true },
    { Name: "Submissions", Icon: Icon.DetailList, Page: MyAppts, Visible: true },
    { Name: "Edit Rooms", Icon: Icon.Settings, Page: ManageDesks, Visible: true },
    { Name: "Create New", Icon: Icon.AddToCalendar, Page: Schedule_Screen, Visible: true }
)
```

### 3.3 Safe fix

```powerfx
// Tabs_3.Items – RECOMMENDED (admin-only Edit Rooms)
// Rollback: change Visible: varAdmin back to Visible: true
Table(
    { Name: "Home", Icon: Icon.Home, Page: Dashboard, Visible: true },
    { Name: "Submissions", Icon: Icon.DetailList, Page: MyAppts, Visible: true },
    { Name: "Edit Rooms", Icon: Icon.Settings, Page: ManageDesks, Visible: varAdmin },
    { Name: "Create New", Icon: Icon.AddToCalendar, Page: Schedule_Screen, Visible: true }
)
```

## 4. Schedule_Screen – Timeslot Selection & Variable Initialization (4b)

**Key file:** `Src/Schedule_Screen.fx.yaml`

### 4.1 Overview

`Schedule_Screen` renders time-axis and weekday galleries, filtered by building (`dropdown_filterBLDG`) and room (`dropdown_filterROOM`). `OnVisible` resets selection state, rebuilds clinic list, computes vacancy summary (`varVacantBlocksQTY`). Each weekday gallery `OnSelect` sets selection variables and navigates to `ModifyTimeSlot`.

### 4.2 Monday gallery pattern

- Uses `Concurrent` for grouped `Set()` calls.
- Separates slot selection from availability logic.
- Navigates last → improves variable consistency.

### 4.3 Risks

- Reliance on `ID + 1` / `ID + 2` for consecutive slots may break with gaps.
- Secondary/tertiary slot variables risk pointing to stale filtered rows after user changes building/room.

### 4.4 Recommendations

1. Align Tuesday–Friday `OnSelect` to Monday pattern (Concurrent grouping, final navigation).
2. Add comment documenting sequential ID assumption.
3. Add logical comment headers inside `OnVisible` for readability (no functional change).

## 5. ModifyTimeSlot – Clinical & Double-booking Logic (4c)

**Key file:** `Src/ModifyTimeSlot.fx.yaml`

### 5.1 Behavior Summary

- Computes expiration timestamp via weekday-based `Switch`.
- Manages clinical input interplay between `tbClinical` (free text) and `Dropdown1` (`col_FilteredClinics`).
- Builds filtered clinics list (prefix match on building codes; ensures `NOT LISTED`).
- Derives end time from start time + duration.
- Handles recurrence and double-book acknowledgment overlay.

### 5.2 Fragility Causes

- Duplicate end-time calculations (OnVisible, RadioGroupCanvas1, Button1_12).
- Repetition of placeholder string checks.
- Deep nested `If` blocks mixing validation and navigation.

### 5.3 Recommendations

1. Single-source end time (remove recompute from Button1_12).
2. Normalize clinic text once at top of Button1_12 using a `With` → set `varClinicalFreeText` → branch only on blank vs not blank.
3. Add a comment summarizing double-book overlay flow.

## 6. MyAppts – Interaction Issues (4d)

**Key file:** `Src/MyAppts.fx.yaml`

### Issues

1. Upcoming filter excludes reservations submitted by the current user if not the selected clinician.
2. Cancellation confirmation button only shows error Notify – no actual navigation or record selection handling.

### Recommendations

```powerfx
// gallUpcoming.Items – broaden filter
FirstN(
    SortByColumns(
        Filter(
            App_ReservationLog,
            currentUser.Email = selectedClinicalStaff_email ||
            Modified_SubmitterEmail_text = currentUser.Email
        ),
        "Modified", SortOrder.Descending
    ),
    6
)
```

```powerfx
// btnConfirmDelete_1.OnSelect – navigate to Reservation for controlled cancel
Set(varSelectedReservation, varReservationToCancel);
UpdateContext({ varConfirmCancel: false });
Navigate(Reservation, ScreenTransition.Fade);
```

## 7. Confirm Screen & btnLooksGood (4e)

Add validation-first, `IfError`-wrapped Patch pattern before navigation. Ensure mapping for all selected variables; clear transient collections post-submit.

## 8. ManageDesks / NewEditDesk / Reservation (4f, 4g)

Standardize on: selected record ID variable → `LookUp` in Patch; use `IfError`. Avoid mixing legacy desk list vs telehealth log in a single action without clear intent.

## 9. Help / User Guide (4h)

Hybrid approach: Global `Help` screen + per-screen `?` icon toggling small contextual tips or navigating with `varHelpTopic` set.

## 10. Legacy Elements & Cleanup

Safe deletions: hidden deprecated containers. Archive large commented logic under a `// LEGACY LOGIC ARCHIVE` block. Preserve rollback clarity.

## 11. Confidence & Next Steps

High-confidence tasks: admin gating, weekday gallery alignment, end-time deduplication, clinic normalization, broaden MyAppts filter, cancellation navigation, help UX, cleanup.

## 12. Additional Screens (BookFor, DateSelection, DeskSelect, NewBooking, Charts)

Legacy desk path vs telehealth path: consider gating legacy to admins while telemetry collected for retirement decision.

## 13. App-wide Patterns

- Dual booking paradigms – need authoritative path decision.
- Shared global variables – document ownership.
- Mixed data sources – consolidate to `App_ReservationLog` for telehealth.
- Admin gating consistency – expand `varAdmin` usage.
- Overlay reuse – centralize destructive actions.

## 14. Data Model Integrity & Field Mapping

Include field map comments above submissions. Use authoritative list (`App_ReservationLog`).

## 15. Delegation & Performance

- Replace `CountIf` with `CountRows(Filter(...))`.
- Throttle `Refresh()` with timestamp variable.
- Plan migration from ID arithmetic to ordered collection indexing.

## 16. Accessibility Backlog

Prioritize AccessibleLabel coverage, consistent TabIndex ordering, focus visibility, contrast checks, success Announce usage.

## 17. Component Standardization

Consolidate ad-hoc overlays into `Dialog` component; introduce variant prop for warning vs confirmation flows.

## 18. Legacy vs Telehealth Strategy

Short-term: gate legacy screens; track usage; plan phased retirement after inactivity window.

## 19. Implementation Roadmap (Summary)

1. Admin tab gating
2. Weekday gallery refactor
3. End-time deduplication
4. Clinic normalization
5. MyAppts filter
6. Cancel navigation
7. Accessibility labels/focus
8. Delegation improvements
9. Slot indexing resilience
10. Dialog consolidation
11. Legacy gating
12. Help system

Rollback: always preserve previous formula in comment or duplicate hidden control.

## 20. Optional Deliverables

Available on request: full formula rewrites, Patch button, accessibility bundle, dialog spec.

End of extended analysis additions (Sections 14–20).

## 21. Change Verification & Test Checklist (New)

## 21. Change Verification & Test Checklist

The app is a phone-layout Telehealth scheduling and reservation interface backed by SharePoint lists `TelehealthMasterSched_CombiTable` and `App_ReservationLog`, with additional lists like `List_Desks` and `App_User_list`.
// Call after successful validation
**Key file:** `Src/App.fx.yaml`
    ChangeId: GUID(),

- `varAllowMultipleDeskSelections = true`
  Screen: App.ActiveScreen.Name,
  Timestamp: Now(),
  - The *active* admin condition is correct and used by multiple tabs for visibility.
- Two reservation preview galleries exist:
  });

### 3.2 Issue 4a – "Edit Rooms" visibility for admins only

\n## 26. Delegation Worksheet
        Page: Dashboard,
        Icon: Icon.Settings,

## 27. Enhancement Approach

## 28. Hardening Opportunities

| Data submission | btnLooksGood Patch | High | Corrupt SharePoint record | Replace with prior Patch; delete new row | < 5 min |
Collect(colChangeAudit, {
    ChangeId: GUID(),
    User: currentUser.Email,
    Screen: App.ActiveScreen.Name,
    Timestamp: Now(),
    Description: "Applied Button1_12 refactor"
});

```
## 22. Risk Matrix & Rollback Strategy

| Change Category | Examples | Risk Level | Primary Risk | Rollback Mechanism | Max Rollback Time |
|-----------------|----------|-----------|--------------|--------------------|-------------------|
| Visibility gating | Tabs_3 admin flag | Low | Accidental hiding | Replace `Visible: varAdmin` with `true` | < 1 min |
| Selection logic | Weekday gallery refactor | Medium | Mis-set variables → wrong slot | Paste old Set() block from comments | < 3 min |
| Clinical normalization | Button1_12.OnSelect | Medium | Clinic text lost (Blank) | Restore commented legacy block | < 3 min |
| Data submission | btnLooksGood Patch | High | Corrupt SharePoint record | Replace with prior Patch; delete new row | < 5 min |
| Delegation changes | Vacancy calc, slot indexing | Medium | Partial dataset (non-delegable) | Revert to CountIf / ID arithmetic | < 2 min |
| Accessibility | Adding labels/tab order | Low | Visual layout shift | Remove added properties | < 1 min |
| Component consolidation | Dialog replacing container | Medium | Overlay not appearing | Show legacy container; hide dialog | < 2 min |
| Legacy gating | Hiding old screens | Low | User confusion | Re-enable navigation item | < 1 min |

Rollback principle: EVERY change must retain either (a) commented original formula directly above new one, or (b) duplicate hidden control (`*_Test`).

## 23. Metrics & Monitoring Plan

Track leading indicators to detect regressions early.

| Metric | Collection Method | Frequency | Trigger Threshold | Action |
|--------|------------------|----------|-------------------|--------|
| Submission success rate | Count successful Patch vs error Notify | Daily | < 95% success | Inspect failing Patch contexts |
| Double-book acknowledgements | Count `varDoubleBook_Attestation` writes | Weekly | Sudden spike > 3x baseline | Assess schedule overlap logic |
| Slot selection latency | Time from gallery tap to ModifyTimeSlot visible | Weekly sample | > 1500 ms | Add caching / reduce Set calls |
| Delegation warnings count | Manual scan of yellow indicators | Weekly | Any new indicator | Refactor formula to delegable alternative |
| Accessibility coverage | % interactive controls with AccessibleLabel | Monthly | < 90% | Patch missing labels |
| Legacy screen usage | Rows in `colLegacyUsage` | Monthly | Continual use after gating | Delay retirement; gather user feedback |
| Error banner occurrences | Monitor session logs | Weekly | Upward trend | Correlate with last deployed change |

Sample monitoring collector:
```powerfx
// After each successful reservation submit
Collect(colMetrics_Submissions, {
  Timestamp: Now(),
  User: currentUser.Email,
  SlotId: varSelectedSchedSlot_RowNumber,
  DoubleBook: varDoubleBook_Attestation = "I aknowledge"
});
```

## 24. Accessibility Detailed Mapping Worksheet

| Control                   | Type              | Current Label           | Needs AccessibleLabel?       | Needs TabIndex? | Focus Visible?    | Notes                                    |
| ------------------------- | ----------------- | ----------------------- | ---------------------------- | --------------- | ----------------- | ---------------------------------------- |
| imgLogo                   | Image             | "menu ima" (incomplete) | Yes ("Open navigation menu") | Yes (1)         | Add border        | Replace placeholder text                 |
| imgRight                  | Image             | Missing                 | Yes ("Open actions menu")    | Yes (2)         | Add border        | Ensure distinct color                    |
| lblBack                   | Label             | BACK                    | Optional (decorative)        | No (non-focus)  | N/A               | Consider Title Case                      |
| Button1_12                | Button            | "NEXT PAGE" (assumed)   | Confirm                      | Yes             | Confirm thickness | Add success Announce                     |
| Tabs_3 items              | Gallery templates | Icon only               | Yes per item                 | Yes sequential  | Icon focus ring   | Use semantic label: "Navigate Home" etc. |
| Reservation cancel button | Button            | Possibly missing        | Yes                          | Yes             | Ensure ring       | Critical action emphasis                 |

Announce pattern for success:

```powerfx
Announce("Reservation submitted successfully for room " & varSelectedSched_roomNumber_text);
```

## 25. Data Integrity Validation Steps

1. Perform 3 test submissions (distinct rooms & days).
2. Export `App_ReservationLog` filtered to those rows; verify internal column values: start/end times, clinic text, combi table row number references.
3. Independently look up the referenced `TelehealthMasterSched_CombiTable` rows by `RowNumber` to confirm they match chosen times.
4. Run a PowerShell script (example pseudo) to assert non-empty required fields.

Example PowerShell outline (not executed here):

```powershell
# Pseudo-validation
$list = "App_ReservationLog"; $required = 'TimeSlot_Start_time','TimeSlot_End_time','CBOC_Name_text','Room_number'
# Export via Graph/SharePoint API then test each field not null
```

## 26. Delegation Audit Worksheet

| Formula Location                            | Current Expression                             | Delegable?             | Proposed Replacement       | Notes                              |
| ------------------------------------------- | ---------------------------------------------- | ---------------------- | -------------------------- | ---------------------------------- |
| Vacancy calc (Schedule_Screen)              | CountIf(TelehealthMasterSched_CombiTable, ...) | No                     | CountRows(Filter(...))     | Replace first; measure perf        |
| Weekday gallery Items (if using AddColumns) | AddColumns(Filter(...), ...)                   | Partial                | Pre-collect then reference | Only if delegation warnings appear |
| Charts Pie data                             | Hard-coded Table(...)                          | N/A                    | Filtered collection bound  | Optional accuracy     |
| MyAppts gallUpcoming                        | Filter(App_ReservationLog, A                   |                        | B)                         | Yes (if both columns delegable)    |
| ModifyTimeSlot clinic filter                | Filter(col_TelehealthClinics, StartsWith(...)) | Yes (local collection) | Keep                       | No change required                 |

Delegation confirmation method: open formula bar; if yellow warning appears for a change, apply pre-filter or remove unsupported functions (`Lower`, `CountIf`).

## 27. Progressive Enhancement Approach

| Wave | Scope                                                           | Goal                             |
| ---- | --------------------------------------------------------------- | -------------------------------- |
| 1    | Admin gating, vacancy calc, weekday gallery Monday → Tuesday   | Stabilize selection & visibility |
| 2    | Button1_12 refactor, MyAppts filter, cancellation navigation    | Improve core booking reliability |
| 3    | Submission Patch hardening (btnLooksGood), accessibility labels | Data integrity + usability       |
| 4    | Slot resilience indexing, throttled refresh                     | Performance + scalability        |
| 5    | Dialog component consolidation, help system                     | UX consistency                   |
| 6    | Legacy gating & retirement metrics                              | Surface area reduction           |

Each wave ends with completion of Section 21 checklist and a metrics snapshot.

## 28. Future Hardening Opportunities

| Idea                                            | Benefit                            | Effort | Notes                                 |
| ----------------------------------------------- | ---------------------------------- | ------ | ------------------------------------- |
| Add ALM pipeline with solution export diffing   | Automated regression detection     | Medium | Use `pac solution export` nightly   |
| Integrate automated accessibility scan          | Continuous a11y compliance         | Medium | Use Power Apps checker API script     |
| Introduce retention policy audit                | Ensure older reservations archived | Low    | Scheduled Flow to move old rows       |
| Add environment variable for double-book policy | Configurable governance            | Low    | Replace hard-coded attestation string |
| Implement test harness screen                   | Safe sandbox for formula trials    | Medium | Screen hidden behind `varAdmin`     |

## 29. Consolidated Rollback Index

| Refactor ID | Section                           | Rollback Note Reference                             |
| ----------- | --------------------------------- | --------------------------------------------------- |
| R1          | Tabs_3 admin gating               | Comment:`// PREVIOUS: Visible:true`               |
| R2          | Weekday gallery unified pattern   | Original Set() block kept above new code            |
| R3          | Button1_12 clinical normalization | Multi-line comment at top of new formula            |
| R4          | MyAppts filter broaden            | Remove OR clause `                                  |
| R5          | Cancellation navigation           | Restore `Notify("ALERT - ERROR!!!!...")`          |
| R6          | btnLooksGood Patch template       | Replace whole formula with commented legacy version |
| R7          | Vacancy calc delegation fix       | Reinsert CountIf version from comment               |
| R8          | Slot indexing resilience          | Remove orderedSlots + use `ID+1` arithmetic       |
| R9          | Accessibility patches             | Delete added AccessibleLabel / Focus properties     |
| R10         | Dialog consolidation              | Hide dialog; show original container                |
| R11         | Help icon pattern                 | Remove icon +`varHelpTopic` usage                 |

## 30. App Checker Analysis (SARIF Report)

### 30.1 Overview
The App Checker report (`Entropy/AppCheckerResult.sarif`) highlights several key areas for improvement, primarily focusing on delegation warnings, accessibility gaps, and potential formula errors.

### 30.2 Critical Issues (High Priority)
- **Invalid Name References in `NewEditDesk`**:
  - `NewEditDesk.toggleActive.Default` and `OnCheck`/`OnUncheck` reference `.RoomActive_text`.
  - **Error**: `app-ErrInvalidName` and `app-ErrIncompatibleTypesForEquality`.
  - **Analysis**: The formula likely tries to access a property of a record that isn't properly scoped or loaded. If `toggleActive` is inside a form or gallery, ensure `ThisItem` or the parent context is correct. If it's a standalone control, verify the variable holding the record (e.g., `varManageSelectedDesk`) actually has the `RoomActive_text` field populated.

### 30.3 Delegation Warnings (Medium Priority)
- **`CountIf` Usage**:
  - Used in `Charts.PieChart1.Items` and `Charts.Slider1`.
  - **Issue**: `CountIf` is not delegable to SharePoint for large datasets.
  - **Recommendation**: Replace with `CountRows(Filter(...))` where possible, or ensure the dataset is small enough to be pre-loaded into a collection.
- **`Filter` with `Lower`**:
  - Used in `ManageDesks.galInactive.Items`.
  - **Issue**: `Lower(RoomActive_text)` is not delegable.
  - **Recommendation**: Create a calculated column in SharePoint (e.g., `RoomActive_Lower`) or ensure the source column is case-insensitive and filter directly (e.g., `RoomActive_text = "no"`).

### 30.4 Accessibility Gaps (Low/Medium Priority)
- **Missing `AccessibleLabel`**:
  - Numerous controls (`Tabs.Gallery4.Icon10`, `Header...imgBack`, `Charts.ColumnChart1`, `SearchBox.txtSearchInput_1`) lack accessible labels.
  - **Impact**: Screen readers will not announce the purpose of these controls.
  - **Fix**: Add descriptive text strings to the `AccessibleLabel` property for all interactive controls.
- **Missing `TabIndex`**:
  - Many interactive controls (`Icon`, `Label` with OnSelect) have no `TabIndex` defined.
  - **Fix**: Set `TabIndex` to `0` (or a sequence) to ensure keyboard navigability.
- **Focus Border Visibility**:
  - `FocusedBorderThickness` is often missing or 0.
  - **Fix**: Set `FocusedBorderThickness` to at least `2` and ensure `FocusedBorderColor` contrasts with the background.

## 31. Connection Analysis

**Key file:** `Connections/Connections.json`

The app relies on two primary connectors:
1.  **SharePoint** (`shared_sharepointonline`):
    -   **Sites**:
        -   `https://dvagov.sharepoint.com/sites/578TelehealthResourceApp` (Primary Data)
        -   `https://dvagov.sharepoint.com/sites/vhahin/svc/ci/TelehealthTeamApp` (Legacy/Desk Data)
    -   **Lists**:
        -   `App_ReservationLog`: Main reservation history.
        -   `TelehealthMasterSched_CombiTable`: Master schedule for rooms.
        -   `App_User_list`: User roles and permissions.
        -   `AppLoadAudit`: Usage logging.
        -   `List_DeskReservations`: Legacy desk reservations.
        -   `List_Desks`: Desk metadata.
2.  **Office 365 Users** (`shared_office365users`):
    -   Used for `MyProfile`, `UserPhotoV2`, `SearchUser`.
    -   Critical for `App.OnStart` user context initialization and `BookFor` screen user search.

**Observation**: The split between two SharePoint sites suggests a migration or federation of data. Ensure the account running the app (or the users) has permissions to *both* sites.

## 32. Deep Dive: Reservation Screen

**Key file:** `Src/Reservation.fx.yaml`

### 32.1 Purpose
Displays details of a specific reservation (`varSelectedReservation`) and allows "Check In" or "Cancellation".

### 32.2 Data Binding & Internal Names
The screen uses `varSelectedReservation` properties that map to internal SharePoint names (likely from `App_ReservationLog` or `List_DeskReservations` depending on the source):
-   `field_1`: CBOC Name?
-   `field_2`: Room Number?
-   `field_11`: Floor?
-   `field_9`: Map/Day?
-   `field_12`: Description/Clinic Name?
-   `field_27`: Reserved Time?
-   `field_8`: Request Created Date?

**Risk**: Using `field_X` names is fragile. If the list schema changes or is re-created, these internal names might change.
**Recommendation**: Verify these mappings against the actual SharePoint list schema. If possible, use the display names or logical names if the connector supports it, or document these mappings rigorously.

### 32.3 "Check In" / Confirm Logic
-   **Button**: `Button1_7`
-   **Logic**:
    ```powerfx
    If(
        varSelectedReservation.reservationStatus_Choice.Value = "Approved",
        "Confirm Reservation",
        "Back"
    )
    ```
-   **Action**: The `OnSelect` contains commented-out `Patch` code for `List_DeskReservations`. Currently, it just executes `Back()`.
-   **Issue**: The "Confirm" action is effectively disabled.
-   **Fix**: Uncomment and verify the `Patch` logic. Ensure it targets the correct list (`App_ReservationLog` vs `List_DeskReservations`).

### 32.4 Cancellation Logic
-   **Group**: `grpConfirmCancel_1`
-   **Action**: `btnConfirmDelete_2` executes `Remove(List_DeskReservations, varSelectedReservation)`.
-   **Risk**: This hardcodes `List_DeskReservations`. If the reservation is from `App_ReservationLog`, this `Remove` call will fail or remove the wrong item (if IDs collide, though unlikely across lists).
-   **Recommendation**: Use a conditional check or a separate variable to determine the source list of `varSelectedReservation` and `Remove` from the correct one.

## 33. Deep Dive: ManageDesks Screen

**Key file:** `Src/ManageDesks.fx.yaml`

### 33.1 Purpose
Admin screen to manage room availability (`TelehealthMasterSched_CombiTable`).

### 33.2 Active/Inactive Logic
-   **Galleries**: `galActive` and `galInactive` filter `TelehealthMasterSched_CombiTable` based on `RoomActive_text`.
-   **Deactivate**: `Button3_1` patches `RoomActive_text` to "no".
-   **Activate**: `Button3_6` patches `RoomActive_text` to "yes".
-   **Observation**: The filter logic uses `Lower(RoomActive_text) <> "no"` for active, which handles "Yes", "yes", and blank. This is robust but non-delegable (see Section 30).

### 33.3 Delete Logic Bug
-   **Button**: `btnConfirmDelete`
-   **Code**:
    ```powerfx
    Patch(
        TelehealthMasterSched_CombiTable,
        {
            RoomActive_text: "MARKED FOR DELETE"
        }
    );
    ```
-   **Critical Bug**: This `Patch` is missing the *record* argument (the second argument). As written, it attempts to create a *new* record with "MARKED FOR DELETE" instead of updating the selected desk.
-   **Fix**:
    ```powerfx
    Patch(
        TelehealthMasterSched_CombiTable,
        varDeskToDelete.RowData, // Ensure varDeskToDelete has the RowData or ID
        {
            RoomActive_text: "MARKED FOR DELETE"
        }
    );
    ```
    *Note*: `varDeskToDelete` is set in `Button3_5` (`UpdateContext({varDeskToDelete:ThisItem})`). `ThisItem` in the gallery seems to be a shaped record (`Value`, `RowData`). So `varDeskToDelete.RowData` is likely the correct reference to the SharePoint item.

## 34. Component Analysis

**Key path:** `pkgs/Components/`

The app uses several custom components to standardize UI:
-   **Dialog** (`Dialog.fx.yaml`):
    -   Standard modal dialog.
    -   **Accessibility**: Has some focus/tab index issues (see Section 30).
    -   **Usage**: Should be the standard for all confirmations (replacing ad-hoc groups like `grpConfirmCancel`).
-   **Header** (`Header.fx.yaml`):
    -   Standard top bar.
    -   **Accessibility**: Missing labels on back/logo images.
-   **Panel** (`Panel.fx.yaml`):
    -   Slide-out panel?
    -   **Accessibility**: Similar focus/label issues.
-   **Tabs** (`Tabs.fx.yaml`):
    -   Bottom navigation.
    -   **Logic**: `Items` property drives the content.
    -   **Recommendation**: Ensure the `Visible` property in the `Items` table is respected by the gallery template (it seems to be, based on `Tabs_3` analysis).

## 35. Deep Dive: Critical Bug Analysis

### 35.1 NewEditDesk: Data Corruption (Critical)
**File:** `Src/NewEditDesk.fx.yaml`
**Control:** `Button1_6` (Save/Submit)

The `Patch` function is passing **Control Objects** instead of **Text Values** to SharePoint.
```powerfx
// CURRENT (BROKEN)
Room_number: tbRoomNumberDesk,
Room_Alias_number: tbAlias,
Room_Extension_number: tbRoomNumberDesk_1,
```
**Impact:** This attempts to save the entire control object (properties, styles, etc.) into a text column. SharePoint will likely receive `"[object Object]"` or the operation will fail silently.
**Fix:** Append `.Text` to all text input references (e.g., `tbRoomNumberDesk.Text`)

### 35.2 ManageDesks: Deletion Failure (Critical)
**File:** `Src/ManageDesks.fx.yaml`
**Control:** `btnConfirmDelete`

The `Patch` function is missing the **Record** argument.
```powerfx
// CURRENT (BROKEN)
Patch(
    TelehealthMasterSched_CombiTable,
    { RoomActive_text: "MARKED FOR DELETE" }
)
```
**Impact:** This attempts to create a **NEW** record with only one field populated, rather than updating the selected room.
**Fix:** Pass the record context: `Patch(TelehealthMasterSched_CombiTable, varDeskToDelete.RowData, ...)`

### 35.3 Reservation: Broken Cancellation (High)
**File:** `Src/Reservation.fx.yaml`
**Control:** `btnConfirmDelete_2`

The cancellation logic targets the legacy list `List_DeskReservations` exclusively.
```powerfx
// CURRENT (Legacy Only)
Remove(List_DeskReservations, varSelectedReservation)
```
**Impact:** If the user navigates from `MyAppts` (which uses `App_ReservationLog`), `varSelectedReservation` belongs to the new list. Attempting to remove it from the old list will fail or do nothing.
**Fix:** Conditional logic to detect the source list or use `App_ReservationLog` as the primary.

### 35.4 Confirm: Fragile String Logic (Medium)
**File:** `Src/Confirm.fx.yaml`
**Control:** `btnLooksGood`

Logic relies on a misspelled hardcoded string.
```powerfx
If(varDoubleBook_Attestation = "I aknowledge", ...)
```
**Impact:** If a developer fixes the typo in the UI ("I acknowledge") without updating this hidden logic, the double-booking flag will fail to set.

## 36. Roadmap for Immediate Fixes

1.  **Stop the Bleeding:** Fix `NewEditDesk` immediately to prevent data corruption.
2.  **Restore Admin Control:** Fix `ManageDesks` deletion to allow proper room management.
3.  **Enable User Self-Service:** Fix `Reservation` cancellation so users don't need to email admins.
4.  **Stabilize Core Logic:** Fix the "aknowledge" typo and `App.OnStart` scalability issues.

End of report.
