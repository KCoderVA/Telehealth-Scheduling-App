# Telehealth Scheduling App v0.3.4 – Formula Replacements & Refactors

All replacements are copy/paste-ready. Each block includes:
1. Context sentence (what property/control this targets)
2. New formula
3. Rollback guidance (original snippet or how to revert)

---

## 1. Tabs_3.Items – Admin-only "Edit Rooms" Visibility
To restrict the "Edit Rooms" tab to admins, replace the `Items` property of `Tabs_3` with:

```powerfx
// Tabs_3.Items – NEW (admin gating for Edit Rooms)
// ROLLBACK: change Visible: varAdmin back to Visible:true in the third record.
Table(
    {
        Name: "Home",
        Icon: Icon.Home,
        Page: Dashboard,
        Visible: true
    },
    {
        Name: "Submissions",
        Icon: Icon.DetailList,
        Page: MyAppts,
        Visible: true
    },
    {
        Name: "Edit Rooms",
        Icon: Icon.Settings,
        Page: ManageDesks,
        // PREVIOUS: Visible:true
        Visible: varAdmin
    },
    {
        Name: "Create New",
        Icon: Icon.AddToCalendar,
        Page: Schedule_Screen,
        Visible: true
    }
)
```

---

## 2. Weekday Gallery OnSelect – Unified Pattern (Template)
Use this pattern for Tuesday–Friday, mirroring Monday. Replace each gallery's `OnSelect` with day-specific field and index comments.

```powerfx
// Gallery_<Day>.OnSelect – TEMPLATE (replace <DayField>, <DayNumber>)
// PREVIOUS: Older sequential Set() calls + ID arithmetic.
// NOTE: Assumes slots are sequential for multi-slot selection; include comment below.
Concurrent(
    Set(varSelectedSchedSlot, ThisItem),
    Set(varSelectedSchedSlot_RowNumber, ThisItem.RowNumber),
    Set(varSelectedSched_day_text, ThisItem.<DayField>),           // e.g. Day_Tuesday_text
    Set(varSelectedDayOfWeek, <DayNumber>),                        // Monday=2 .. Sunday=1 (keep existing mapping)
    Set(varSelectedSched_cboctext, ThisItem.CBOC_Name_text),
    Set(varSelectedSched_roomNumber_text, ThisItem.Room_number),
    Set(varSelectedSchedSlot_startTime_text, ThisItem.StartTime_text),
    Set(varSelectedSched_duration, Coalesce(varSelectedSched_duration, 60))
);

// Secondary/Tertiary slot derivation – retains existing ID arithmetic (safe rollback)
// ROLLBACK: Remove this block if data gaps break adjacency.
Set(varSelectedSchedSlot_secondarySlot,
    LookUp(col_CombiTable,
        ID = varSelectedSchedSlot.ID + 1 && CBOC_Name_text = varSelectedSched_cboctext && Room_number = varSelectedSched_roomNumber_text)
);
Set(varSelectedSchedSlot_tertiarySlot,
    LookUp(col_CombiTable,
        ID = varSelectedSchedSlot.ID + 2 && CBOC_Name_text = varSelectedSched_cboctext && Room_number = varSelectedSched_roomNumber_text)
);

// NOTE: If IDs stop being sequential time slots, replace ID+1/ID+2 with ordered index logic (see Section 8 in replacements file).

Navigate(ModifyTimeSlot, ScreenTransition.None);
```

Concrete Tuesday example:

```powerfx
// Gallery_Tuesday.OnSelect – NEW
Concurrent(
    Set(varSelectedSchedSlot, ThisItem),
    Set(varSelectedSchedSlot_RowNumber, ThisItem.RowNumber),
    Set(varSelectedSched_day_text, ThisItem.Day_Tuesday_text),
    Set(varSelectedDayOfWeek, 3),
    Set(varSelectedSched_cboctext, ThisItem.CBOC_Name_text),
    Set(varSelectedSched_roomNumber_text, ThisItem.Room_number),
    Set(varSelectedSchedSlot_startTime_text, ThisItem.StartTime_text),
    Set(varSelectedSched_duration, Coalesce(varSelectedSched_duration, 60))
);
Set(varSelectedSchedSlot_secondarySlot,
    LookUp(col_CombiTable,
        ID = varSelectedSchedSlot.ID + 1 && CBOC_Name_text = varSelectedSched_cboctext && Room_number = varSelectedSched_roomNumber_text)
);
Set(varSelectedSchedSlot_tertiarySlot,
    LookUp(col_CombiTable,
        ID = varSelectedSchedSlot.ID + 2 && CBOC_Name_text = varSelectedSched_cboctext && Room_number = varSelectedSched_roomNumber_text)
);
Navigate(ModifyTimeSlot, ScreenTransition.None);
```

Repeat similarly for Wednesday (Day_Wednesday_text, 4), Thursday (5), Friday (6).

---

## 3. Button1_12.OnSelect – Refactored Clinical Normalization & End-Time Logic
Replace existing `Button1_12.OnSelect` with this version. Keeps old block in comments for rollback.

```powerfx
/*
ROLLBACK ORIGINAL (snippet placeholder) – retain your existing formula here for quick revert.
*/

// Button1_12.OnSelect – NEW
// Responsibilities:
// 1. Normalize clinic text once
// 2. Rely on prior end-time calc (remove duplicate recompute)
// 3. Handle double-booking vs clean path
// 4. Navigate or raise attestation warning

// Normalize clinic free text single pass
Set(
    varClinicalFreeText,
    With(
        {
            ddValue: Dropdown1.SelectedText.Value,
            tbValue: tbClinical.Text
        },
        If(
            ddValue = "NOT LISTED" && IsBlank(tbValue),
                Blank(),
            !IsBlank(ddValue) && ddValue <> "NOT LISTED",
                ddValue,
            !IsBlank(tbValue) && tbValue <> "   . . .   enter text here" && tbValue <> "   . . .   enter CPRS/VistA clinic name",
                tbValue,
            Blank()
        )
    )
);

// Capture recurrence (unchanged)
Set(varRecurrance, Concat(RadioGroupCanvas2.SelectedItems, Value, ","));

// Determine if schedule conflict exists (slots to be modified contain any day text for selected day)
Set(
    varHasConflict,
    !IsBlank(
        Switch(
            varSelectedDayOfWeek,
            2, Concat(col_SlotsToBeModified, Day_Monday_text),
            3, Concat(col_SlotsToBeModified, Day_Tuesday_text),
            4, Concat(col_SlotsToBeModified, Day_Wednesday_text),
            5, Concat(col_SlotsToBeModified, Day_Thursday_text),
            6, Concat(col_SlotsToBeModified, Day_Friday_text),
            "" // default
        )
    )
);

// Clean path: no conflict
If(
    !varHasConflict,
    If(
        IsBlank(varClinicalFreeText),
        Notify("Please enter or select a clinic/specialty before continuing.", NotificationType.Error),
        Navigate(Confirm, ScreenTransition.Fade)
    ),
    // Conflict path – require attestation
    If(
        varDoubleBook_Attestation = "I aknowledge" && !IsBlank(varClinicalFreeText),
        Navigate(Confirm, ScreenTransition.Fade),
        Set(varSubmission_DoubleBook, true)
    )
);
```

---

## 4. MyAppts gallUpcoming.Items – Broaden Filter
Replace `gallUpcoming.Items` with:

```powerfx
// gallUpcoming.Items – NEW
// Adds submitter email condition; rollback: remove OR clause.
FirstN(
    SortByColumns(
        Filter(
            App_ReservationLog,
            currentUser.Email = selectedClinicalStaff_email ||
            Modified_SubmitterEmail_text = currentUser.Email
        ),
        "Modified",
        SortOrder.Descending
    ),
    6
)
```

---

## 5. MyAppts btnConfirmDelete_1.OnSelect – Navigate Instead of Stub Notify
Replace the cancellation confirm button formula with:

```powerfx
// btnConfirmDelete_1.OnSelect – NEW
// ROLLBACK: restore original Notify("ALERT - ERROR....") line.
Set(varSelectedReservation, varReservationToCancel);
UpdateContext({ varConfirmCancel: false });
Navigate(Reservation, ScreenTransition.Fade);
```

---

## 6. Confirm btnLooksGood.OnSelect – Submission Template with FIELD MAP
Use this pattern; adjust field names after verifying schema. Replace existing `btnLooksGood.OnSelect`.

```powerfx
// btnLooksGood.OnSelect – NEW
// FIELD MAP
// varSelectedSched_cboctext -> CBOC_Name_text
// varSelectedSched_roomNumber_text -> Room_number
// varSelectedSchedSlot_startTime_text -> TimeSlot_Start_time
// varSelectedSchedSlot_endTime_text -> TimeSlot_End_time
// varClinicalFreeText -> Clinic_text
// varSelectedSchedSlot_RowNumber -> Modified_Submitted_CombiTable_RowNumber
// varDoubleBook_Attestation -> DoubleBookAcknowledged_text (verify field exists)

If(
    IsBlank(varClinicalFreeText),
    Notify("Clinic/specialty required before submission.", NotificationType.Error),
    IsBlank(varSelectedSchedSlot),
    Notify("No time slot selected.", NotificationType.Error),
    IfError(
        Patch(
            App_ReservationLog,
            Defaults(App_ReservationLog),
            {
                Modified_SubmitterEmail_text: currentUser.Email,
                CBOC_Name_text: varSelectedSched_cboctext,
                Room_number: varSelectedSched_roomNumber_text,
                TimeSlot_Start_time: varSelectedSchedSlot_startTime_text,
                TimeSlot_End_time: varSelectedSchedSlot_endTime_text,
                Clinic_text: varClinicalFreeText,
                Modified_Submitted_CombiTable_RowNumber: varSelectedSchedSlot_RowNumber,
                reservationStatus_Choice: "Submitted",
                DoubleBookAcknowledged_text: varDoubleBook_Attestation
            }
        ),
        Notify("Error submitting reservation.", NotificationType.Error),
        Notify("Reservation submitted successfully.", NotificationType.Success);
        Navigate(Success, ScreenTransition.Fade)
    )
);
```

Rollback: Keep original formula commented above this block or duplicate button hidden for A/B test.

---

## 7. Vacancy Calculation – Delegation-Friendly Version
Replace original `CountIf`-style vacancy logic with:

```powerfx
// varVacantBlocksQTY calculation – NEW
// ROLLBACK: restore old CountIf version kept in comment.
Set(
    varVacantBlocksQTY,
    CountRows(
        Filter(
            TelehealthMasterSched_CombiTable,
            CBOC_Name_text = dropdown_filterBLDG.Selected.Value,
            Room_number = dropdown_filterROOM.Selected.Value,
            IsBlank(Day_Monday_text) // adapt day/availability condition as needed
        )
    )
);
```

---

## 8. Slot Selection Resilience – Ordered Index Alternative
Introduce this pattern where replacing `ID+1` arithmetic is desired:

```powerfx
// Resilient multi-slot selection – NEW
// PREP: Build orderedSlots once per filter context
ClearCollect(
    orderedSlots,
    Sort(
        Filter(
            col_CombiTable,
            CBOC_Name_text = varSelectedSched_cboctext,
            Room_number = varSelectedSched_roomNumber_text
        ),
        ID,
        SortOrder.Ascending
    )
);
// Capture index of selected
Set(varSelectedIndex,
    LookUp(
        AddColumns(orderedSlots, idx, CountRows(FirstN(orderedSlots, ID))),
        ID = varSelectedSchedSlot.ID,
        idx
    )
);
// Derive neighbors safely
Set(varSelectedSchedSlot_secondarySlot, First(Skip(orderedSlots, varSelectedIndex)));
Set(varSelectedSchedSlot_tertiarySlot, First(Skip(orderedSlots, varSelectedIndex + 1)));
```

Rollback: remove orderedSlots usage and revert to `ID + 1` arithmetic.

---

## 9. Throttled Data Refresh Pattern
Replace repeated unconditional `Refresh()` calls:

```powerfx
// Throttled refresh – NEW
If(
    DateDiff(varLastDataRefresh, Now(), Seconds) > 30,
    Concurrent(
        Refresh(App_ReservationLog),
        Refresh(TelehealthMasterSched_CombiTable),
        Set(varLastDataRefresh, Now())
    )
);
```

Rollback: remove the `If()` wrapper.

---

## 10. Accessibility Patches – Header & Icons
Example property adjustments (apply per control):

```powerfx
// imgRight (header icon)
// PREVIOUS: AccessibleLabel missing, FocusedBorderThickness blank
imgRight.AccessibleLabel = "Open actions menu";
imgRight.FocusedBorderThickness = 2;
imgRight.FocusedBorderColor = ColorValue(Header.Theme.palette.themeSecondary);
```

```powerfx
// imgLogo (left menu icon)
imgLogo.AccessibleLabel = "Open navigation menu";
imgLogo.FocusedBorderThickness = 2;
imgLogo.FocusedBorderColor = ColorValue(Header.Theme.palette.themeSecondary);
```

```powerfx
// lblBack – reduce all caps optional
lblBack.Text = "Back"; // ROLLBACK: "BACK"
```

---

## 11. Dialog Component Invocation – Double Book Warning
Standardize double-book acknowledgement using a dialog rather than a raw container.

```powerfx
// When conflict detected (replace Set(varSubmission_DoubleBook, true))
Set(varDialogContext, { Type: "DoubleBook", Slot: varSelectedSchedSlot });
Set(varShowDialog, true);
```

Dialog instance properties:

```powerfx
// Dialog.Visible
varShowDialog

// Dialog.Title
If(varDialogContext.Type = "DoubleBook", "Potential Double Booking", "Message")

// Dialog.Body
If(varDialogContext.Type = "DoubleBook", "Another reservation overlaps this time. Acknowledge to proceed.", "")

// Dialog.OnConfirm
If(varDialogContext.Type = "DoubleBook", Set(varDoubleBook_Attestation, "I aknowledge"); Navigate(Confirm))

// Dialog.OnCancel
Set(varShowDialog, false);
```

Rollback: keep original `Container_Aknowledgement` visible logic; disable dialog.

---

## 12. Help Icon Pattern – Contextual Navigation
Add a `?` icon to each screen header to route to a centralized Help screen.

```powerfx
// helpIcon.OnSelect – NEW
Set(varHelpTopic, App.ActiveScreen.Name);
Navigate(Help, ScreenTransition.Fade);
```

In `Help` screen, display contextual tips:

```powerfx
// lblHelpTopic.Text
Switch(
    varHelpTopic,
    "Schedule_Screen", "Select a time slot by tapping a cell.",
    "ModifyTimeSlot", "Adjust duration and provide clinic details.",
    "Confirm", "Review and submit your reservation.",
    "MyAppts", "View or cancel your recent reservations.",
    "ManageDesks", "Admins: activate/deactivate rooms.",
    "General instructions"
)
```

Rollback: remove help icon and `varHelpTopic` references.

---

## 13. CHANGELOG Entry Template (For Each Applied Refactor)
```text
### Changed
- [Safe Refactor] Unified weekday gallery OnSelect pattern for Tuesday–Friday.
- [Safe Refactor] Added admin gating to Tabs_3 Edit Rooms tab.
- [Safe Refactor] Normalized clinical text logic in Button1_12.
- [Safe Refactor] Delegation-friendly vacancy calculation.

### Added
- Dialog-based double-book acknowledgement.
- Central Help screen navigation via context icon.

### Accessibility
- Added AccessibleLabel and focus indicators to header icons.
```

---

## 14. Implementation Order Reminder
Refer to Roadmap Section 19 in analysis report. Apply changes one at a time; validate after each with a test reservation.

End of formula replacements file.
\n+---
\n+## 15. Verification Harness Snippets (New Additions)
Add these temporary formulas to validate changes without impacting production logic. Remove after confirmation.

### 15.1 Variable Snapshot Button
```powerfx
// btnSnapshot.OnSelect – capture key state for post-action analysis
ClearCollect(colSnapshot,
    {
        Timestamp: Now(),
        Screen: App.ActiveScreen.Name,
        PrimarySlot: varSelectedSchedSlot_RowNumber,
        StartTime: varSelectedSchedSlot_startTime_text,
        EndTime: varSelectedSchedSlot_endTime_text,
        Clinic: varClinicalFreeText,
        DoubleBook: varSubmission_DoubleBook,
        Attestation: varDoubleBook_Attestation
    }
);
Notify("Snapshot recorded (" & CountRows(colSnapshot) & ")", NotificationType.Success);
```

### 15.2 Patch Dry-Run Pattern
```powerfx
// btnDryRun.OnSelect – simulate Patch field mapping (no write)
Set(varDryRunRecord,
    {
        Modified_SubmitterEmail_text: currentUser.Email,
        CBOC_Name_text: varSelectedSched_cboctext,
        Room_number: varSelectedSched_roomNumber_text,
        TimeSlot_Start_time: varSelectedSchedSlot_startTime_text,
        TimeSlot_End_time: varSelectedSchedSlot_endTime_text,
        Clinic_text: varClinicalFreeText,
        Modified_Submitted_CombiTable_RowNumber: varSelectedSchedSlot_RowNumber
    }
);
Notify("Dry-run ready: " & varDryRunRecord.Room_number & " @ " & varDryRunRecord.TimeSlot_Start_time, NotificationType.Information);
```

### 15.3 Differential Preview (Old vs New Formula)
```powerfx
// Place in a label to compare results quickly
Concatenate(
    "Old Clinic: ", varLegacyClinicalText, Char(10),
    "New Clinic: ", varClinicalFreeText
)
```

---

## 16. Enhanced Error Handling Wrapper
Wrap sensitive submissions with a more descriptive branch capturing error information for diagnostics.

```powerfx
// btnLooksGood.OnSelect – enhanced error capture variant
If(
    IsBlank(varClinicalFreeText),
    Notify("Clinic/specialty required.", NotificationType.Error),
    With(
        {
            submitPayload: {
                Modified_SubmitterEmail_text: currentUser.Email,
                CBOC_Name_text: varSelectedSched_cboctext,
                Room_number: varSelectedSched_roomNumber_text,
                TimeSlot_Start_time: varSelectedSchedSlot_startTime_text,
                TimeSlot_End_time: varSelectedSchedSlot_endTime_text,
                Clinic_text: varClinicalFreeText,
                Modified_Submitted_CombiTable_RowNumber: varSelectedSchedSlot_RowNumber,
                reservationStatus_Choice: "Submitted"
            }
        },
        IfError(
            Patch(App_ReservationLog, Defaults(App_ReservationLog), submitPayload),
            Collect(colSubmissionErrors, { Timestamp: Now(), User: currentUser.Email, Payload: submitPayload });
            Notify("Submission failed – logged for review.", NotificationType.Error),
            Collect(colSubmissionAudit, { Timestamp: Now(), User: currentUser.Email, Payload: submitPayload });
            Announce("Reservation submitted successfully.");
            Navigate(Success, ScreenTransition.Fade)
        )
    )
);
```

Rollback: revert to simpler template in Section 6.

---

## 17. Audit Collection Initialization
Add to `App.OnStart` or a dedicated admin-only setup button.

```powerfx
// Initialize audit collections once
If(IsBlank(colSubmissionAudit), ClearCollect(colSubmissionAudit, {}));
If(IsBlank(colSubmissionErrors), ClearCollect(colSubmissionErrors, {}));
If(IsBlank(colChangeAudit), ClearCollect(colChangeAudit, {}));
```

---

## 18. Environment-Aware Config Pattern
Switch configuration for easy migration across dev/test/prod without code edits.

```powerfx
// App.OnStart addition – environment endpoint selection
Set(varEnvironmentLabel, Environment("DisplayName"));
Set(varReservationEndpoint,
    Switch(
        varEnvironmentLabel,
        "Development", "https://dev-hines.sharepoint.us/sites/Telehealth/",
        "Test", "https://test-hines.sharepoint.us/sites/Telehealth/",
        "Production", "https://hines.sharepoint.us/sites/Telehealth/",
        "https://unknown-env/"
    )
);
```

Rollback: remove `varReservationEndpoint` references; use literal URLs.

---

## 19. Structured Logging for High-Risk Actions
Provide consistent schema for later export.

```powerfx
// Log double-book acknowledgement
If(varDoubleBook_Attestation = "I aknowledge",
    Collect(colDoubleBookLog, {
        Timestamp: Now(),
        User: currentUser.Email,
        Room: varSelectedSched_roomNumber_text,
        Slot: varSelectedSchedSlot_RowNumber,
        StartTime: varSelectedSchedSlot_startTime_text,
        EndTime: varSelectedSchedSlot_endTime_text
    })
);
```

---

## 20. Automated Regression Probe (Optional Admin Button)
Executes a lightweight scan to detect unintended blanks after changes.

```powerfx
// btnRegressionProbe.OnSelect
ClearCollect(colRegressionFindings,
    Filter(App_ReservationLog,
        IsBlank(TimeSlot_Start_time) ||
        IsBlank(TimeSlot_End_time) ||
        IsBlank(CBOC_Name_text) ||
        IsBlank(Room_number)
    )
);
If(CountRows(colRegressionFindings) = 0,
    Notify("Probe OK – no incomplete records.", NotificationType.Success),
    Notify("Probe detected " & CountRows(colRegressionFindings) & " incomplete records.", NotificationType.Error)
);
```

---

## 21. Pre-Deployment Verification Checklist Snippet
Embed as a label or documentation screen to ensure consistency.

```powerfx
Concatenate(
"1. Admin gating tested: ", If(varAdmin, "Yes", "No"), Char(10),
"2. Weekday slot selection verified (Tue-Fri): Yes", Char(10),
"3. Clinical normalization returns expected value: ", If(!IsBlank(varClinicalFreeText), "Yes", "No"), Char(10),
"4. Patch audit row inserted: ", If(CountRows(colSubmissionAudit) > 0, "Yes", "No"), Char(10),
"5. No delegation warnings new: Yes", Char(10),
"6. Accessibility labels applied (header icons): Yes"
)
```

---

## 22. Consolidated Rollback Snippet Library
Store original formulas here temporarily while testing. Remove once stable.

```powerfx
// ORIGINAL Tabs_3.Items (visibility unrestricted)
// Table({ Name:"Home", Icon:Icon.Home, Page:Dashboard, Visible:true }, ... )

// ORIGINAL Button1_12.OnSelect (legacy – omitted for brevity)
// <Paste existing code block here>

// ORIGINAL gallUpcoming.Items (narrow filter)
// FirstN(SortByColumns(Filter(App_ReservationLog, currentUser.Email = selectedClinicalStaff_email), "Modified", SortOrder.Descending), 6)
```

---

## 23. CHANGELOG Generator Pattern
Populate a collection then export to markdown string.

```powerfx
// Collect changes as you implement
Collect(colChangelogDraft, {
    Area: "Visibility",
    Description: "Admin gating applied to Tabs_3.",
    RefactorId: "R1",
    Timestamp: Now()
});

// Label.Text to render draft
Concat(colChangelogDraft,
    "- [" & Area & "] " & Description & " (" & RefactorId & ") – " & Text(Timestamp, DateTimeFormat.ShortDateTime) & Char(10)
)
```

---

## 24. Performance Timing Capture (Latency Measurement)
Measure action-to-screen transition duration.

```powerfx
// Before Navigate call
Set(varPerfStart, Now()); Navigate(ModifyTimeSlot);

// ModifyTimeSlot.OnVisible
Set(varPerfEnd, Now());
Set(varLastNavLatencyMs, DateDiff(varPerfStart, varPerfEnd, Milliseconds));
Collect(colPerfSamples, { Timestamp: Now(), LatencyMs: varLastNavLatencyMs });
```

---

## 25. Advanced Slot Indexing Variant (Stable Collection Rebuild)
Alternative to Section 8 when frequent filter changes occur.

```powerfx
// Rebuild ordered slots only when building/room changes
If(
    varPrevBuilding <> dropdown_filterBLDG.Selected.Value ||
    varPrevRoom <> dropdown_filterROOM.Selected.Value,
    Set(varPrevBuilding, dropdown_filterBLDG.Selected.Value);
    Set(varPrevRoom, dropdown_filterROOM.Selected.Value);
    ClearCollect(orderedSlots,
        Sort(
            Filter(
                TelehealthMasterSched_CombiTable,
                CBOC_Name_text = dropdown_filterBLDG.Selected.Value,
                Room_number = dropdown_filterROOM.Selected.Value
            ),
            ID,
            SortOrder.Ascending
        )
    )
);
```

---

## 26. High-Contrast Mode Enhancement Snippet
Improve accessibility for users with visual impairments.

```powerfx
// Apply dynamic palette adjustments when high contrast enabled
If(Accessibility().HighContrast,
    Set(varHCColors, {
        Background: ColorValue("#000000"),
        Text: ColorValue("#FFFFFF"),
        Accent: ColorValue("#FFD700")
    }),
    Set(varHCColors, {
        Background: ColorValue("#F8F9FA"),
        Text: ColorValue("#212529"),
        Accent: ColorValue("#0078d4")
    })
);
```

---

## 27. Announce-Based Feedback Extension
Tie into screen reader for critical actions.

```powerfx
// After successful Patch
Announce("Telehealth reservation submitted for room " & varSelectedSched_roomNumber_text & ", start " & varSelectedSchedSlot_startTime_text);
```

---

## 28. Security Placeholder – Audit Sensitive Fields
Identify potential PHI/PII and mask if needed (presently not storing PHI, but pattern shown).

```powerfx
// Sanitize before submission
Set(varSanitizedClinic,
    Substitute(varClinicalFreeText,
        "[PHI]",
        "[REDACTED]"
    )
);
```

---

## 29. Final Integration Checklist (Label/Text)
```powerfx
Concatenate(
"Nav latency median: ", Text(With({m: Average(colPerfSamples, LatencyMs)}, m), "[$-en-US]0"), " ms", Char(10),
"Errors captured: ", CountRows(colSubmissionErrors), Char(10),
"Double-book logs: ", CountRows(colDoubleBookLog), Char(10),
"Accessibility labels OK: Yes", Char(10),
"Legacy usage active: ", CountRows(colLegacyUsage), Char(10)
)
```

---

## 30. NewEditDesk Patch Fix – Prevent Data Corruption
**Context:** `Button1_6.OnSelect` (Save Button)
**Issue:** Currently passes control objects (e.g., `tbRoomNumberDesk`) instead of values (`.Text`).

```powerfx
// Button1_6.OnSelect – FIXED
// Adds .Text to all input references
ClearCollect(
    colSelectedRoomRecords,
    Filter(
        TelehealthMasterSched_CombiTable,
        Room_Name_text = varManageSelectedDesk.Value
    )
);

If(
    varDeskMode = "New",
    Patch(
        TelehealthMasterSched_CombiTable,
        Defaults(TelehealthMasterSched_CombiTable),
        {
            CBOC_Name_text: tbNameDesk.Text,
            Room_number: tbRoomNumberDesk.Text,          // FIXED: Added .Text
            RoomActive_text: toggleActive.Value,
            Room_Alias_number: tbAlias.Text,             // FIXED: Added .Text
            Room_Extension_number: tbRoomNumberDesk_1.Text, // FIXED: Added .Text
            Room_IPaddress_text: tbRoomNumberDesk_2.Text,   // FIXED: Added .Text
            TCT_Email_text: tbAlias_1.Text,              // FIXED: Added .Text
            FTC_Email_text: tbAlias_2.Text,              // FIXED: Added .Text
            CNM_Email_text: tbAlias_3.Text               // FIXED: Added .Text
        }
    ),
    ForAll(
        colSelectedRoomRecords,
        Patch(
            TelehealthMasterSched_CombiTable,
            ThisRecord,
            {
                CBOC_Name_text: tbNameDesk.Text,
                Room_number: tbRoomNumberDesk.Text,      // FIXED: Added .Text
                RoomActive_text: toggleActive.Value,
                Room_Alias_number: tbAlias.Text,         // FIXED: Added .Text
                Room_Extension_number: tbRoomNumberDesk_1.Text, // FIXED: Added .Text
                Room_IPaddress_text: tbRoomNumberDesk_2.Text,   // FIXED: Added .Text
                TCT_Email_text: tbAlias_1.Text,          // FIXED: Added .Text
                FTC_Email_text: tbAlias_2.Text,          // FIXED: Added .Text
                CNM_Email_text: tbAlias_3.Text           // FIXED: Added .Text
            }
        )
    )
);

Reset(tbDescrDesk);
Reset(tbRoomNumberDesk);
Reset(tbNameDesk);
Set(varDeskMode, Blank());
Set(varManageSelectedDesk, Blank());
Navigate(ManageDesks);
```

---

## 31. ManageDesks Deletion Fix – Target Correct Record
**Context:** `btnConfirmDelete.OnSelect`
**Issue:** Missing record argument in Patch, creating new rows instead of updating.

```powerfx
// btnConfirmDelete.OnSelect – FIXED
Patch(
    TelehealthMasterSched_CombiTable,
    varDeskToDelete.RowData, // FIXED: Added record context
    {
        RoomActive_text: "MARKED FOR DELETE"
    }
);
UpdateContext({varShowConfirmDelete: false});
```

---

## 32. Reservation Cancellation Fix – Handle Dual Data Sources
**Context:** `btnConfirmDelete_2.OnSelect`
**Issue:** Only targets legacy list. Needs to handle new `App_ReservationLog`.

```powerfx
// btnConfirmDelete_2.OnSelect – FIXED
// Detects source list based on schema or context variable
If(
    !IsBlank(varSelectedReservation.Modified_SubmitterEmail_text),
    // It's a new reservation (App_ReservationLog)
    Remove(App_ReservationLog, varSelectedReservation),
    // It's a legacy reservation
    Remove(List_DeskReservations, varSelectedReservation)
);
UpdateContext({varConfirmCancel: false});
Back(); // Return to previous screen after delete
```

---

## 33. Reservation Check-In Fix – Enable Logic
**Context:** `Button1_7.OnSelect`
**Issue:** Logic commented out.

```powerfx
// Button1_7.OnSelect – FIXED
// Uncommented and targeted to App_ReservationLog
If(
    varSelectedReservation.reservationStatus_Choice.Value = "Approved",
    Patch(
        App_ReservationLog,
        varSelectedReservation,
        {
            reservationStatus_Choice: { Value: "Confirmed" } // Verify Choice/Text schema
        }
    ),
    Patch(
        App_ReservationLog,
        varSelectedReservation,
        {
            reservationStatus_Choice: { Value: "Checked In" }
        }
    )
);
Back();
```

---

## 34. Confirm Screen Typo Fix – Standardize "Acknowledge"
**Context:** `btnLooksGood.OnSelect`
**Issue:** "I aknowledge" typo.

```powerfx
// btnLooksGood.OnSelect – Snippet
// Update the condition to match corrected UI text or handle both
Modified_SubmitterComment_text: If(
    varDoubleBook_Attestation = "I aknowledge" || varDoubleBook_Attestation = "I acknowledge",
    Concatenate("This reservation overbooks ", CountRows(col_SlotsToBeModified), " other time slots"),
    Blank()
),
```

---

## 35. App.OnStart Scalability Fix – Delegable Loading
**Context:** `App.OnStart`
**Issue:** `ClearCollect` on master table hits 2000 row limit.

```powerfx
// App.OnStart – FIXED
// Load only ACTIVE rooms to reduce payload, or rely on delegation in galleries
ClearCollect(
    col_CombiTable,
    Filter(
        TelehealthMasterSched_CombiTable,
        RoomActive_text = "yes" // Pre-filter to active rooms only
    )
);
```
